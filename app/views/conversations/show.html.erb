<div class="container py-4 d-flex flex-column chat-screen">
  <!-- Header -->
  <div class="d-flex align-items-center mb-3">
    <h1 class="h3 m-0"><%= @conversation.title.presence || "Conversation ##{@conversation.id}" %></h1>
    <div class="ms-auto">
      <%= link_to "All Conversations", conversations_path, class: "btn btn-outline-secondary btn-sm me-2" %>
      <%= link_to conversation_path(@conversation),
            class: "btn btn-outline-secondary btn-sm",
            data: { turbo_method: :delete, turbo_confirm: "Delete this conversation?" } do %>
        <i class="fa-solid fa-trash-can"></i>
      <% end %>
    </div>
  </div>
  <!-- Submitted text -->
  <% if @conversation.submitted_text.present? %>
    <div class="card mb-3">
      <div class="card-header fw-semibold">Original Text</div>
      <div class="card-body">
        <pre class="mb-0" style="white-space: pre-wrap;"><%= @conversation.submitted_text %></pre>
      </div>
    </div>
  <% end %>
  <!-- Messages (scrollable) -->
  <div id="messages" class="flex-grow-1 overflow-auto mb-3 border rounded p-3 bg-light">
    <% if @responses.any? %>
      <div class="d-flex flex-column gap-3">
        <% @responses.each do |r| %>
          <div class="d-flex <%= r.role == "user" ? 'justify-content-end' : 'justify-content-start' %>">
            <div class="chat-bubble <%= r.role == "user" ? 'user' : 'ai' %>">
              <div class="small <%= r.role == "user" ? 'text-white-50' : 'text-muted' %> mb-1">
                <%= r.role == "user" ? (current_user.name.presence || "You") : "Robobo" %>
                · <%= time_ago_in_words(r.created_at) %> ago
              </div>
              <div style="white-space: pre-wrap;"><%= raw(render_markdown(r.content)) %></div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-muted mb-0">No messages yet. Start the conversation below.</p>
    <% end %>
    <div id="bottom" class="mt-4"></div>
  </div>

  <!-- Input at bottom -->
  <%= simple_form_for [@conversation, @response], html: { class: "d-flex gap-2", id: "new-response-form" } do |f| %>
    <%= f.input :content, label: false, wrapper_html: {  class: "flex-grow-1", style: 'margin-bottom: 0 !important;' }, input_html: { rows: 3, placeholder: "Type your message…", class: "flex-grow-1", id: "response-content" } %>
    <%= f.hidden_field :role, value: "user" %>
    <%= f.submit "Send", class: "btn btn-primary" %>
  <% end %>
  <%# TODO: This should be Stimulus %>

  <!-- Page-load smooth autoscroll + autofocus + Ctrl/Cmd+Enter -->
  <script>
    document.addEventListener("turbo:load", () => {
    const bottom = document.getElementById("bottom");
    if (bottom) bottom.scrollIntoView({ block: "end" });

    const textarea = document.getElementById("response-content");
    if (textarea) {
      textarea.focus();
      // Ctrl/Cmd+Enter to submit
      const form = document.getElementById("new-response-form");
      textarea.addEventListener("keydown", (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") form.requestSubmit();
      });
    }
      });
  </script>
</div>
